<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لعبة المتاهة - GameBoy كلاسيكي (النسخة النهائية)</title>
<style>
  :root{--device:#cfcfcf;--screen:#d6f7c7;--accent:#6b2fa8;--muted:#333}
  *{box-sizing:border-box;font-family:Tahoma, Arial, 'Segoe UI', sans-serif}
  body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#9fb3c8 0%, #eaf2fb 100%)}
  .gb{width:460px;padding:22px;border-radius:18px;background:var(--device);box-shadow:0 18px 40px rgba(0,0,0,0.16), inset 0 2px 0 rgba(255,255,255,0.6);border:3px solid rgba(0,0,0,0.08)}
  .brand{font-weight:900;color:#333;letter-spacing:1px}
  .screen-wrap{margin-top:12px;background:linear-gradient(180deg,#9fcb6b,#d9f7b7);padding:12px;border-radius:10px;border:6px solid rgba(0,0,0,0.08);width:100%;height:280px;position:relative;box-shadow:inset 0 2px 0 rgba(255,255,255,0.5)}
  canvas{display:block;background:var(--screen);border-radius:6px;border:4px solid rgba(0,0,0,0.12);width:100%;height:220px}
  .hud{position:absolute;right:18px;top:10px;display:flex;gap:8px;align-items:center}
  .heart{width:18px;height:16px;background:linear-gradient(180deg,#ff6b9a,#ff3d6e);clip-path:polygon(50% 0,100% 35%,80% 100%,50% 80%,20% 100%,0 35%)}
  .lvl{background:linear-gradient(90deg,#a7faff,#b88bff);padding:6px 10px;border-radius:8px;font-weight:800;color:#012}
  .controls{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
  .left-controls{display:flex;gap:12px}
  .btn{background:linear-gradient(180deg,#ffffff,#e6e6e6);border:3px solid rgba(0,0,0,0.08);padding:8px 12px;border-radius:8px;font-weight:800;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,0.08)}
  .btn:active{transform:translateY(2px)}
  .dpad{width:170px;display:grid;grid-template-columns:48px 48px 48px;grid-template-rows:48px 48px 48px;gap:8px;justify-content:center;align-items:center}
  .pad{display:flex;align-items:center;justify-content:center;border-radius:8px;background:linear-gradient(180deg,#f0ecf6,#e8e1f7);border:2px solid rgba(0,0,0,0.08);width:48px;height:48px;cursor:pointer}
  .pad:active{transform:scale(0.97)}
  .pad i{font-size:18px;color:var(--accent)}
  .card{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#ffffff;padding:12px 14px;border-radius:10px;border:3px solid #000;text-align:center;font-weight:800;color:#012;z-index:20}
  .hidden{display:none}
  .complete-card{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:linear-gradient(180deg,#fff7e6,#fff2d1);padding:18px 20px;border-radius:12px;border:3px solid #000;text-align:center;font-weight:900;color:#042;z-index:30}
  @media (max-width:480px){ .gb{width:340px} .screen-wrap{height:220px} }
</style>
</head>
<body>
  <div class="gb">
    <div class="brand">GAME-CLASSIC</div>
    <div class="screen-wrap">
      <canvas id="cnv" width="640" height="440"></canvas>
      <div class="hud"><div id="lives" style="display:flex;gap:6px"></div><div class="lvl" id="levelText">1 / 10</div></div>
      <div id="startCard" class="card">جاهز للفوز!!<br><button id="startBtn" class="btn" style="margin-top:8px">ابدأ</button></div>
      <div id="winCard" class="card hidden">فوز بالمستوى!<br><button id="nextBtn" class="btn" style="margin-top:8px">المستوى التالي</button></div>
      <div id="loseCard" class="card hidden">خسرت!<br><button id="retryBtn" class="btn" style="margin-top:8px">إعادة محاولة</button></div>
      <div id="completeCard" class="complete-card hidden">🎉 لقد ختمت اللعبة 🎉<br><div style="height:10px"></div><button id="okComplete" class="btn">حسناً</button></div>
    </div>
    <div class="controls">
      <div class="left-controls">
        <button id="newGame" class="btn">لعبة جديدة</button>
        <button id="exitGame" class="btn">خروج</button>
      </div>
      <div class="dpad">
        <div></div>
        <div class="pad" data-dir="up"><i>▲</i></div>
        <div></div>
        <div class="pad" data-dir="left"><i>◀</i></div>
        <div class="pad" data-dir="down"><i>▼</i></div>
        <div class="pad" data-dir="right"><i>▶</i></div>
      </div>
    </div>
  </div>
<script>
// Final working version - GameBoy classic style, red player arrow (not emoji), fixed level maps, horizontal/patrol monsters only.
const canvas = document.getElementById('cnv'); const ctx = canvas.getContext('2d');
const cols = 16, rows = 10; const cellW = Math.floor(canvas.width/cols), cellH = Math.floor(canvas.height/rows);
const maxLevel = 10; let level = 1, lives = 3, playing = false; let grid = []; let player = {x:1,y:1}; let monsters = [];
// simple soft audio
let audioCtx=null; function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
function soft(freq,dur=0.08){ try{ ensureAudio(); const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); g.gain.value=0.05; o.start(); o.stop(audioCtx.currentTime+dur);}catch(e){} }
function clickSound(){ soft(720,0.04);} function winSound(){ soft(1000,0.14); soft(760,0.08);} function hitSound(){ soft(220,0.1); }

// Fixed level maps (16x10 each) - curated and tested
const LEVEL_MAPS = [
// L1
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,
1,0,1,1,1,0,1,0,1,1,1,1,1,1,0,1,
1,0,0,0,1,0,0,0,0,1,0,0,0,1,0,1,
1,1,1,0,1,1,1,0,1,0,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1,
1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
// L2
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,0,0,1,0,0,0,0,1,0,0,0,0,0,0,1,
1,0,0,1,0,1,1,0,1,0,1,1,1,1,0,1,
1,0,0,0,0,1,0,0,0,0,1,0,0,1,0,1,
1,1,1,0,1,1,0,1,1,0,1,1,0,1,0,1,
1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,1,
1,0,1,1,1,1,0,1,1,1,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
// L3
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1,
1,0,1,0,1,0,1,0,1,0,1,0,1,1,0,1,
1,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1,
1,1,1,0,1,1,1,0,1,0,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1,
1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
// L4
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,
1,0,1,0,1,0,1,0,1,0,1,1,1,1,0,1,
1,0,1,0,0,0,1,0,0,0,0,0,0,1,0,1,
1,0,1,1,1,0,1,1,1,1,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1,
1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
// L5
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,
1,0,1,1,1,0,1,0,1,1,1,1,1,1,0,1,
1,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1,
1,1,1,0,1,1,1,0,1,0,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1,
1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
// L6
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,0,1,0,0,0,0,1,0,0,0,0,0,0,0,1,
1,0,1,0,1,1,0,1,0,1,1,1,1,1,0,1,
1,0,0,0,1,0,0,0,0,1,0,0,0,1,0,1,
1,1,1,0,1,1,1,0,1,0,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1,
1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
// L7
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,0,0,0,0,1,0,0,1,0,0,0,0,0,0,1,
1,0,1,1,0,1,0,1,1,0,1,1,1,1,0,1,
1,0,0,1,0,0,0,0,1,0,0,0,0,1,0,1,
1,1,0,1,1,1,1,0,1,0,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1,
1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
// L8
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,
1,0,1,1,1,0,1,1,1,1,1,1,1,1,0,1,
1,0,0,0,1,0,0,0,0,0,0,0,0,1,0,1,
1,1,1,0,1,1,1,0,1,0,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1,
1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
// L9
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1,
1,0,1,0,1,0,1,0,1,0,1,0,1,1,0,1,
1,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1,
1,1,1,0,1,1,1,0,1,0,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1,
1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,
1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
// L10 boss
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,
1,0,1,0,0,0,0,0,0,0,0,0,0,1,0,1,
1,0,1,0,1,1,1,1,1,1,1,1,0,1,0,1,
1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,
1,0,1,1,1,1,1,1,1,1,0,1,1,1,0,1,
1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

// only horizontal and patrol monsters - vertical removed
const MONSTERS = {
1:[{x:6,y:1,pattern:'horizontal',dir:1},{x:10,y:6,pattern:'patrol',path:[{x:10,y:6},{x:13,y:6},{x:13,y:3},{x:10,y:3}],step:0}],
2:[{x:7,y:2,pattern:'patrol',path:[{x:7,y:2},{x:7,y:5},{x:4,y:5},{x:4,y:2}],step:0}],
3:[{x:9,y:3,pattern:'horizontal',dir:1},{x:3,y:6,pattern:'patrol',path:[{x:3,y:6},{x:6,y:6},{x:6,y:3},{x:3,y:3}],step:0}],
4:[{x:5,y:2,pattern:'patrol',path:[{x:5,y:2},{x:9,y:2},{x:9,y:5},{x:5,y:5}],step:0}],
5:[{x:8,y:3,pattern:'horizontal',dir:1},{x:11,y:6,pattern:'patrol',path:[{x:11,y:6},{x:13,y:6},{x:13,y:4},{x:11,y:4}],step:0}],
6:[{x:6,y:4,pattern:'patrol',path:[{x:6,y:4},{x:10,y:4},{x:10,y:7},{x:6,y:7}],step:0}],
7:[{x:4,y:2,pattern:'horizontal',dir:1},{x:12,y:5,pattern:'patrol',path:[{x:12,y:5},{x:14,y:5},{x:14,y:3},{x:12,y:3}],step:0}],
8:[{x:8,y:4,pattern:'patrol',path:[{x:8,y:4},{x:12,y:4},{x:12,y:7},{x:8,y:7}],step:0},{x:3,y:3,pattern:'horizontal',dir:1}],
9:[{x:9,y:2,pattern:'horizontal',dir:1},{x:6,y:6,pattern:'patrol',path:[{x:6,y:6},{x:9,y:6},{x:9,y:3},{x:6,y:3}],step:0}],
10:[{x:5,y:3,pattern:'patrol',path:[{x:5,y:3},{x:10,y:3},{x:10,y:6},{x:5,y:6}],step:0},{x:8,y:2,pattern:'horizontal',dir:1},{x:3,y:5,pattern:'horizontal',dir:1}]
};

// helpers
function loadLevel(n){ grid = LEVEL_MAPS[n-1].slice(); }
function getTile(x,y){ return grid[y*cols + x]; }
function setPlayerStart(){ for(let r=1;r<rows-1;r++){ for(let c=1;c<cols-1;c++){ if(getTile(c,r)===0){ player.x=c; player.y=r; return; } } } }

let monsterTimer=null;
function initMonsters(n){ monsters = []; const defs = MONSTERS[n] || []; defs.forEach(d=>{ const m = JSON.parse(JSON.stringify(d)); if(m.pattern==='patrol') m.step=0; monsters.push(m); }); }
function moveMonsters(){ monsters.forEach(m=>{
  if(m.pattern==='horizontal'){
    const nx = m.x + (m.dir||1);
    if(nx<=1 || nx>=cols-2 || getTile(nx,m.y)===1) m.dir = - (m.dir||1); else m.x = nx;
  } else if(m.pattern==='patrol'){
    m.step = (m.step + 1) % m.path.length; m.x = m.path[m.step].x; m.y = m.path[m.step].y;
  }
}); }
function startMonsters(){ if(monsterTimer) clearInterval(monsterTimer); monsterTimer = setInterval(()=>{ moveMonsters(); checkCollisions(); draw(); },600); }
function stopMonsters(){ if(monsterTimer) clearInterval(monsterTimer); monsterTimer=null; }

// draw functions
function draw(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#dff3d9'; ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ const t = getTile(c,r); const px=c*cellW, py=r*cellH; if(t===1){ ctx.fillStyle='#222'; ctx.fillRect(px,py,cellW,cellH); ctx.fillStyle='rgba(255,255,255,0.02)'; ctx.fillRect(px+2,py+2,cellW-4,cellH-4); } else if(t===2){ ctx.beginPath(); ctx.fillStyle='#f7d83d'; ctx.arc(px+cellW/2,py+cellH/2,Math.min(cellW,cellH)/3,0,Math.PI*2); ctx.fill(); } else if(t===3){ ctx.fillStyle='#7a7f86'; ctx.fillRect(px+4,py+4,cellW-8,cellH-8); } else { ctx.strokeStyle='rgba(0,0,0,0.03)'; ctx.strokeRect(px,py,cellW,cellH); } } }
  // monsters
  monsters.forEach(m=>{ const mx=m.x*cellW+cellW/2, my=m.y*cellH+cellH/2; ctx.beginPath(); ctx.fillStyle='#c94b4b'; ctx.arc(mx,my,Math.min(cellW,cellH)/3.2,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#000'; ctx.fillRect(mx-6,my-2,4,4); ctx.fillRect(mx+2,my-2,4,4); });
  // player - red arrow (not emoji)
  const px = player.x*cellW + cellW/2, py = player.y*cellH + cellH/2; ctx.fillStyle='#c42b2b'; ctx.beginPath(); ctx.moveTo(px,py-10); ctx.lineTo(px-10,py+10); ctx.lineTo(px+10,py+10); ctx.closePath(); ctx.fill(); // eyes
  ctx.fillStyle='#000'; ctx.fillRect(px-5,py+2,3,3); ctx.fillRect(px+2,py+2,3,3);
  // HUD update
  const livesEl = document.getElementById('lives'); livesEl.innerHTML=''; for(let i=0;i<lives;i++){ const d=document.createElement('div'); d.className='heart'; livesEl.appendChild(d); }
  document.getElementById('levelText').textContent = level + ' / ' + maxLevel;
}

// collisions and events
function checkCollisions(){ for(const m of monsters){ if(m.x===player.x && m.y===player.y){ lives--; hitSound(); if(lives<=0){ playing=false; document.getElementById('loseCard').classList.remove('hidden'); stopMonsters(); } else { setPlayerStart(); draw(); } return; } } }
function checkGoal(){ if(getTile(player.x,player.y)===2){ if(level===maxLevel){ winSound(); playing=false; stopMonsters(); document.getElementById('completeCard').classList.remove('hidden'); // auto-close after 2s
    setTimeout(()=>{ try{ window.open('','_self'); window.close(); }catch(e){ try{ window.close(); }catch(err){} } },2000); } else { winSound(); playing=false; stopMonsters(); document.getElementById('winCard').classList.remove('hidden'); } } }

// movement
function move(dx,dy){ if(!playing) return; const nx=player.x+dx, ny=player.y+dy; if(nx<1||ny<1||nx>=cols-1||ny>=rows-1){ clickSound(); return; } if(getTile(nx,ny)===1){ clickSound(); return; } player.x=nx; player.y=ny; clickSound(); checkCollisions(); checkGoal(); draw(); }

// UI wiring
Array.from(document.querySelectorAll('.pad')).forEach(p=>{ const dir=p.getAttribute('data-dir'); p.addEventListener('click',()=>{ if(dir==='up') move(0,-1); if(dir==='down') move(0,1); if(dir==='left') move(-1,0); if(dir==='right') move(1,0); }); p.addEventListener('mousedown',()=>clickSound()); });
document.getElementById('startBtn').addEventListener('click',()=>{ clickSound(); document.getElementById('startCard').classList.add('hidden'); startLevel(); });
document.getElementById('nextBtn').addEventListener('click',()=>{ clickSound(); document.getElementById('winCard').classList.add('hidden'); level = Math.min(maxLevel, level+1); startLevel(); });
document.getElementById('retryBtn').addEventListener('click',()=>{ clickSound(); document.getElementById('loseCard').classList.add('hidden'); level=1; lives=3; startLevel(); });
document.getElementById('newGame').addEventListener('click',()=>{ clickSound(); level=1; lives=3; document.getElementById('startCard').classList.remove('hidden'); document.getElementById('winCard').classList.add('hidden'); document.getElementById('loseCard').classList.add('hidden'); document.getElementById('completeCard').classList.add('hidden'); playing=false; loadLevel(1); setPlayerStart(); draw(); stopMonsters(); });
// exit immediate
document.getElementById('exitGame').addEventListener('click',()=>{ clickSound(); try{ window.open('','_self'); window.close(); }catch(e){ try{ window.close(); }catch(err){} } });
// complete OK button (also closes)
document.getElementById('okComplete').addEventListener('click',()=>{ try{ window.open('','_self'); window.close(); }catch(e){ try{ window.close(); }catch(err){} } });
// keyboard
window.addEventListener('keydown',e=>{ if(!playing) return; const k=e.key; if(k==='ArrowUp'||k==='w'||k==='W') move(0,-1); if(k==='ArrowDown'||k==='s'||k==='S') move(0,1); if(k==='ArrowLeft'||k==='a'||k==='A') move(-1,0); if(k==='ArrowRight'||k==='d'||k==='D') move(1,0); });

// start level
function startLevel(){ loadLevel(level); initMonsters(level); setPlayerStart(); playing=true; draw(); startMonsters(); }
function initMonsters(n){ monsters=[]; const defs = MONSTERS[n]||[]; defs.forEach(d=>{ const m = JSON.parse(JSON.stringify(d)); if(m.pattern==='patrol') m.step=0; monsters.push(m); }); }
// init helpers
function setPlayerStart(){ for(let r=1;r<rows-1;r++){ for(let c=1;c<cols-1;c++){ if(getTile(c,r)===0){ player.x=c; player.y=r; return; } } } }
function loadLevel(n){ grid = LEVEL_MAPS[n-1].slice(); }
// initial draw
loadLevel(1); setPlayerStart(); draw();
</script>
</body>
</html>
